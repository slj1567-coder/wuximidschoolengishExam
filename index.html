<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ— é”¡ä¸­è€ƒè‹±è¯­ä½œæ–‡é€š</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Config for Mobile -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                        serif: ['Georgia', 'Cambria', '"Times New Roman"', 'Times', 'serif'],
                    },
                    padding: {
                        'safe': 'env(safe-area-inset-bottom)',
                    }
                }
            }
        }
    </script>
    
    <style>
        body {
            -webkit-tap-highlight-color: transparent;
            background-color: #f9fafb;
            overscroll-behavior-y: none; /* Prevent pull-to-refresh on mobile */
        }
        
        /* Hide scrollbar for clean UI */
        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- ICONS ---
        const Icons = {
            Home: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>,
            Book: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>,
            History: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>,
            ChevronRight: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>,
            Star: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>,
            Check: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>,
            Sparkles: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>,
            Brain: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"></path><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"></path></svg>,
            Plus: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            X: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
            Wand: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 4V2"></path><path d="M15 16v-2"></path><path d="M8 9h2"></path><path d="M20 9h2"></path><path d="M17.8 11.8L19 13"></path><path d="M15 9h0"></path><path d="M17.8 6.2L19 5"></path><path d="M3 21l9-9"></path><path d="M12.2 6.2L11 5"></path></svg>,
            Edit: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>,
            Trash: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>,
            Settings: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>,
            AlertCircle: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
        };

        // --- GEMINI API UTILS ---
        const callGemini = async (prompt, userApiKey, responseMimeType = "text/plain") => {
            if (!userApiKey) {
                // UI will handle showing toast for missing key
                return null;
            }
            const model = "gemini-1.5-flash"; 
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${userApiKey}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: responseMimeType
                }
            };

            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (error) {
                console.error("Gemini API Failed:", error);
                throw error; // Re-throw to handle in UI
            }
        };

        // --- DATA ---
        const INITIAL_TOPICS = [
          {
            id: 1,
            year: "2023æ¨¡æ‹Ÿ",
            title: "A Day in Wuxi",
            type: "å¯¼æ¸¸ä»‹ç»ç±»",
            difficulty: "Medium",
            prompt: "å‡è®¾ä½ çš„å¤–å›½æœ‹å‹ Tom æ¥åˆ°æ— é”¡ï¼Œè¯·ä½ å†™ä¸€ç¯‡çŸ­æ–‡ä»‹ç»æ— é”¡çš„ä¸€æ—¥æ¸¸è®¡åˆ’ã€‚å†…å®¹åŒ…æ‹¬ï¼šå¤ªæ¹– (Taihu Lake)ã€å°ç¬¼åŒ… (Xiao Long Bao)ã€è ¡å›­ (Liyuan Garden)ã€‚å­—æ•° 80-100 å­—ã€‚",
            hints: ["located in the south of Jiangsu", "famous for", "taste sweet and delicious"],
            modelEssay: "Welcome to Wuxi! It is a beautiful city located in the south of Jiangsu Province. For our one-day trip, we will first visit Taihu Lake. It is one of the largest freshwater lakes in China, and the scenery is breathtaking. For lunch, we must try Wuxi Xiao Long Bao. They are famous for their thin skin and sweet, juicy filling. In the afternoon, we will go to Liyuan Garden to enjoy the classic garden views. I am sure you will have a wonderful time here!"
          },
          {
            id: 2,
            year: "2022çœŸé¢˜",
            title: "Doing Housework",
            type: "è§‚ç‚¹è®®è®ºæ–‡",
            difficulty: "Easy",
            prompt: "æ•™è‚²éƒ¨å‘å¸ƒäº†åŠ³åŠ¨è¯¾ç¨‹æ ‡å‡†ã€‚è¯·ä»¥ 'Doing Housework Makes Me ______' ä¸ºé¢˜ï¼Œå†™ä¸€ç¯‡çŸ­æ–‡ã€‚å†…å®¹åŒ…æ‹¬ï¼šä½ ç»å¸¸åšçš„å®¶åŠ¡ã€ä½ çš„æ„Ÿå—ä»¥åŠåšå®¶åŠ¡çš„å¥½å¤„ã€‚",
            hints: ["sweep the floor", "independent", "skills for the future"],
            modelEssay: "Doing Housework Makes Me Happy. I think doing housework is very meaningful for students. Usually, I help my parents sweep the floor and wash the dishes on weekends. At first, I felt tired, but now I enjoy it. Doing housework not only helps me relax but also teaches me how to take care of myself. It makes me more independent and responsible. I believe these life skills will be useful for my future. Let's enjoy the happiness of labor!"
          }
        ];

        const VOCAB_BANK = {
          "æ— é”¡ç‰¹è‰²": [
            { en: "Taihu Lake", cn: "å¤ªæ¹–" },
            { en: "Turtle Head Isle", cn: "é¼‹å¤´æ¸š" },
            { en: "Lingshan Grand Buddha", cn: "çµå±±å¤§ä½›" },
            { en: "Sweet spareribs", cn: "é…±æ’éª¨" },
            { en: "Clay figurines", cn: "æƒ å±±æ³¥äºº" }
          ],
          "é«˜åˆ†è¿æ¥è¯": [
            { en: "What's more", cn: "æ­¤å¤–" },
            { en: "In my opinion", cn: "ä¾æˆ‘çœ‹" },
            { en: "Last but not least", cn: "æœ€åä½†åŒæ ·é‡è¦çš„æ˜¯" },
            { en: "As a result", cn: "ç»“æœ" }
          ]
        };

        // --- COMPONENTS ---

        // 1. Toast Notification Component
        const Toast = ({ message, type, show, onClose }) => {
            if (!show) return null;
            return (
                <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 z-[100] px-4 py-3 rounded-xl shadow-lg flex items-center gap-2 transition-all duration-300 ${type === 'error' ? 'bg-red-50 text-red-700 border border-red-100' : 'bg-green-50 text-green-700 border border-green-100'}`}>
                    <span className="font-bold text-sm">{message}</span>
                </div>
            );
        };

        // 2. Confirmation Modal Component
        const ConfirmModal = ({ isOpen, title, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/20 backdrop-blur-sm z-[60] flex items-center justify-center p-4 animate-fade-in">
                    <div className="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 transform transition-all scale-100">
                        <h3 className="text-lg font-bold text-gray-900 mb-2">{title}</h3>
                        <p className="text-sm text-gray-500 mb-6">{message}</p>
                        <div className="flex gap-3 justify-end">
                            <button onClick={onCancel} className="px-4 py-2 text-gray-500 font-medium text-sm hover:bg-gray-50 rounded-lg">å–æ¶ˆ</button>
                            <button onClick={onConfirm} className="px-4 py-2 bg-red-500 text-white font-bold text-sm rounded-lg shadow hover:bg-red-600">ç¡®è®¤åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            );
        };

        const HomeView = ({ topics, onStartPractice, onAddTopic, onEditTopic, onDeleteTopic, onOpenSettings }) => (
          <div className="pb-24 pt-6 px-4 relative min-h-screen animate-fade-in">
            <header className="mb-6 flex justify-between items-center">
                <button onClick={onOpenSettings} className="bg-gray-100 text-gray-600 p-2 rounded-full active:scale-95 transition-transform">
                    <Icons.Settings />
                </button>
                <div className="text-center">
                    <h1 className="text-2xl font-bold text-gray-900">æ— é”¡ä¸­è€ƒè‹±è¯­</h1>
                    <p className="text-gray-500 text-xs mt-1">AI æ™ºèƒ½æ‰¹æ”¹åŠ©æ‰‹</p>
                </div>
                <button 
                    onClick={onAddTopic}
                    className="bg-gray-900 text-white p-2 rounded-full shadow-lg active:scale-95 transition-transform"
                >
                    <Icons.Plus />
                </button>
            </header>

            <div className="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl p-5 text-white shadow-lg mb-8">
              <h3 className="font-semibold text-sm mb-2 flex items-center gap-2 text-yellow-300">
                <Icons.Star /> æ¯æ—¥å¿…èƒŒ
              </h3>
              <p className="text-white text-lg font-serif italic mb-1">"Practice makes perfect."</p>
              <p className="text-blue-100 text-xs">ç†Ÿèƒ½ç”Ÿå·§ã€‚</p>
            </div>

            <div className="flex justify-between items-end mb-4">
              <h2 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                é¢˜åº“åˆ—è¡¨
              </h2>
              <span className="text-xs text-gray-400">å…± {topics.length} é¢˜</span>
            </div>

            <div className="space-y-3 pb-safe">
              {topics.map((topic) => (
                <div 
                  key={topic.id} 
                  className="w-full bg-white p-4 rounded-xl shadow-sm border border-gray-100 active:bg-gray-50 transition-colors flex justify-between items-center group relative overflow-hidden"
                  onClick={() => onStartPractice(topic)}
                >
                  <div className="flex-1 cursor-pointer">
                    <div className="flex items-center gap-2 mb-1.5">
                      <span className={`text-[10px] px-2 py-0.5 rounded-full font-bold tracking-wider ${
                        topic.difficulty === 'Custom' ? 'bg-purple-100 text-purple-700' :
                        topic.difficulty === 'Easy' ? 'bg-green-100 text-green-700' : 
                        'bg-yellow-100 text-yellow-700'
                      }`}>
                        {topic.difficulty === 'Custom' ? 'è‡ªå»º' : topic.difficulty}
                      </span>
                      <span className="text-[10px] text-gray-400 font-medium">
                        {topic.year}
                      </span>
                    </div>
                    <h3 className="font-bold text-gray-800 text-base line-clamp-1">{topic.title}</h3>
                    <p className="text-gray-500 text-xs mt-0.5 line-clamp-1">{topic.type}</p>
                  </div>

                  <div className="flex items-center gap-1 pl-2">
                    {topic.difficulty === 'Custom' ? (
                      <div className="flex gap-2">
                        <button 
                          onClick={(e) => { e.stopPropagation(); onEditTopic(topic); }}
                          className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-colors z-10"
                        >
                          <Icons.Edit />
                        </button>
                        <button 
                          onClick={(e) => { e.stopPropagation(); onDeleteTopic(topic.id); }}
                          className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full transition-colors z-10"
                        >
                          <Icons.Trash />
                        </button>
                      </div>
                    ) : (
                      <div className="text-gray-300 pr-2">
                        <Icons.ChevronRight />
                      </div>
                    )}
                  </div>
                </div>
              ))}
            </div>
          </div>
        );

        const SettingsView = ({ apiKey, setApiKey, onSave, onCancel }) => {
            const [localKey, setLocalKey] = useState(apiKey);
            return (
                <div className="flex flex-col h-screen bg-white fixed inset-0 z-50 animate-fade-in">
                    <div className="bg-white px-4 py-3 shadow-sm border-b border-gray-100 flex justify-between items-center">
                        <button onClick={onCancel} className="text-gray-500"><Icons.X /></button>
                        <h2 className="font-bold text-lg text-gray-800">è®¾ç½®</h2>
                        <button onClick={() => onSave(localKey)} className="text-blue-600 font-bold text-sm">ä¿å­˜</button>
                    </div>
                    <div className="p-6">
                        <label className="block text-sm font-bold text-gray-700 mb-2">Google Gemini API Key</label>
                        <input 
                            type="password" 
                            className="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 outline-none focus:ring-2 focus:ring-blue-100 transition-all mb-2"
                            placeholder="è¾“å…¥æ‚¨çš„ API Key..."
                            value={localKey}
                            onChange={(e) => setLocalKey(e.target.value)}
                        />
                        <p className="text-xs text-gray-500 mb-4">
                            ä¸ºäº†ä½¿ç”¨ AI è‡ªåŠ¨å‡ºé¢˜å’Œä½œæ–‡æ‰¹æ”¹åŠŸèƒ½ï¼Œæ‚¨éœ€è¦å¡«å…¥è‡ªå·±çš„ API Keyã€‚
                            æ‚¨çš„ Key ä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­ï¼Œä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨ã€‚
                        </p>
                        <div className="bg-blue-50 p-3 rounded-lg border border-blue-100 flex gap-2 items-start">
                            <Icons.AlertCircle />
                            <p className="text-xs text-blue-700">æ²¡æœ‰ Keyï¼Ÿè¯·å‰å¾€ Google AI Studio å…è´¹ç”³è¯·ã€‚</p>
                        </div>
                    </div>
                </div>
            )
        };

        const AddTopicView = ({ form, setForm, onSubmit, onCancel, isEditing, apiKey, onShowToast }) => {
          const [isGenerating, setIsGenerating] = useState(false);

          const generateHints = async () => {
            if (!apiKey) {
                onShowToast("è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API Key", "error");
                return;
            }
            if (!form.title && !form.prompt) {
              onShowToast("è¯·å…ˆå¡«å†™é¢˜ç›®åç§°æˆ–è¦æ±‚", "error");
              return;
            }
            
            setIsGenerating(true);
            const prompt = `Based on the following English essay topic:
            Title: "${form.title}"
            Requirements: "${form.prompt}"
            
            Please generate 3-5 short English keywords or phrases (hints) suitable for a middle school student to write this essay. 
            Return ONLY a comma-separated string (e.g., "key1, key2 phrase, key3"). No other text.`;

            try {
                const result = await callGemini(prompt, apiKey);
                if (result) {
                  const cleanHints = result.replace(/hints:|keywords:/i, '').trim();
                  setForm(prev => ({ ...prev, hints: cleanHints }));
                  onShowToast("æç¤ºè¯ç”ŸæˆæˆåŠŸ", "success");
                } else {
                  onShowToast("ç”Ÿæˆå¤±è´¥ï¼Œè¯·æª¢æŸ¥ API Key", "error");
                }
            } catch(e) {
                onShowToast("ç¶²è·¯éŒ¯èª¤æˆ– Key ç„¡æ•ˆ", "error");
            }
            setIsGenerating(false);
          };

          return (
            <div className="flex flex-col h-screen bg-white fixed inset-0 z-50 overflow-y-auto animate-fade-in">
               <div className="bg-white px-4 py-3 shadow-sm border-b border-gray-100 flex justify-between items-center sticky top-0 z-10">
                  <button onClick={onCancel} className="text-gray-500">
                     <Icons.X />
                  </button>
                  <h2 className="font-bold text-lg text-gray-800">{isEditing ? "ç¼–è¾‘é¢˜ç›®" : "æ·»åŠ æ–°é¢˜ç›®"}</h2>
                  <button onClick={onSubmit} className="text-blue-600 font-bold text-sm">
                    {isEditing ? "æ›´æ–°" : "ä¿å­˜"}
                  </button>
                </div>
                
                <div className="p-6 space-y-6">
                  <div>
                    <label className="block text-sm font-bold text-gray-700 mb-2">é¢˜ç›®åç§° (Title)</label>
                    <input 
                      type="text" 
                      className="w-full p-3 bg-gray-50 rounded-xl border-none outline-none focus:ring-2 focus:ring-blue-100 transition-all"
                      placeholder="ä¾‹å¦‚ï¼šMy Best Friend"
                      value={form.title}
                      onChange={(e) => setForm({...form, title: e.target.value})}
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-bold text-gray-700 mb-2">å†™ä½œè¦æ±‚ (Prompt)</label>
                    <textarea 
                      className="w-full p-3 bg-gray-50 rounded-xl border-none outline-none focus:ring-2 focus:ring-blue-100 transition-all h-32 resize-none"
                      placeholder="ä¾‹å¦‚ï¼šè¯·æè¿°ä½ æœ€å¥½çš„æœ‹å‹ï¼ŒåŒ…æ‹¬å¤–è²Œå’Œæ€§æ ¼..."
                      value={form.prompt}
                      onChange={(e) => setForm({...form, prompt: e.target.value})}
                    />
                  </div>

                  <div>
                    <div className="flex justify-between items-center mb-2">
                      <label className="block text-sm font-bold text-gray-700">æç¤ºè¯ (Hints)</label>
                      <button 
                        onClick={generateHints}
                        disabled={isGenerating}
                        className={`text-xs flex items-center gap-1 px-3 py-1 rounded-full transition-all ${isGenerating ? 'bg-gray-100 text-gray-400' : 'bg-purple-100 text-purple-600 active:scale-95'}`}
                      >
                        {isGenerating ? 'AI ç”Ÿæˆä¸­...' : <><Icons.Wand /> AI è‡ªåŠ¨ç”Ÿæˆ</>}
                      </button>
                    </div>
                    <input 
                      type="text" 
                      className="w-full p-3 bg-gray-50 rounded-xl border-none outline-none focus:ring-2 focus:ring-blue-100 transition-all"
                      placeholder="ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è‡ªåŠ¨ç”Ÿæˆ..."
                      value={form.hints}
                      onChange={(e) => setForm({...form, hints: e.target.value})}
                    />
                  </div>
                  
                  <div className="bg-blue-50 p-3 rounded-lg text-xs text-blue-700 border border-blue-100">
                    <span className="font-bold">â„¹ï¸ è¯´æ˜ï¼š</span> èŒƒæ–‡å°†åœ¨æ‚¨å®Œæˆç»ƒä¹ å¹¶æäº¤åï¼Œç”± AI è‡ªåŠ¨æ ¹æ®é¢˜ç›®å³æ—¶ç”Ÿæˆï¼Œæ— éœ€åœ¨æ­¤è¾“å…¥ã€‚
                  </div>
                </div>
            </div>
          );
        };

        const PracticeView = ({ selectedTopic, essayContent, setEssayContent, timeLeft, submitEssay, isAnalyzing, onCancel, formatTime }) => {
          if (!selectedTopic) return null;

          const wordCount = essayContent.trim() === '' ? 0 : essayContent.trim().split(/\s+/).length;
          
          if (isAnalyzing) {
            return (
              <div className="flex flex-col items-center justify-center h-screen bg-white fixed inset-0 z-50">
                <div className="relative">
                  <div className="spinner mb-4"></div>
                  <div className="absolute -top-1 -right-1 text-yellow-400 animate-pulse">
                    <Icons.Sparkles />
                  </div>
                </div>
                <p className="text-gray-800 font-bold text-lg animate-pulse">AI æ­£åœ¨æ·±åº¦æ‰¹æ”¹...</p>
                <p className="text-gray-500 text-sm mt-2">åˆ†æè¯­æ³• â€¢ è¯„ä¼°é€»è¾‘ â€¢ ç”Ÿæˆæ»¡åˆ†èŒƒæ–‡</p>
              </div>
            );
          }

          return (
            <div className="flex flex-col h-screen bg-white fixed inset-0 z-50 animate-fade-in">
              <div className="bg-white px-4 py-3 shadow-sm border-b border-gray-100 flex justify-between items-center shrink-0">
                <button onClick={onCancel} className="text-gray-500 text-sm font-medium p-2">
                  å–æ¶ˆ
                </button>
                <div className={`font-mono font-bold text-lg tabular-nums ${timeLeft < 300 ? 'text-red-500' : 'text-gray-800'}`}>
                  {formatTime(timeLeft)}
                </div>
                <button 
                  onClick={submitEssay} 
                  className="bg-blue-600 text-white text-sm font-bold px-4 py-1.5 rounded-full flex items-center gap-1 shadow-md active:scale-95 transition-transform"
                >
                  <Icons.Sparkles /> äº¤å·
                </button>
              </div>

              <div className="bg-blue-50 p-4 border-b border-blue-100 shrink-0 max-h-40 overflow-y-auto">
                <h3 className="font-bold text-gray-800 text-sm mb-1">{selectedTopic.title}</h3>
                <p className="text-xs text-gray-600 leading-relaxed mb-2">{selectedTopic.prompt}</p>
                <div className="flex flex-wrap gap-1.5">
                  {selectedTopic.hints && selectedTopic.hints.map((hint, i) => (
                    <span key={i} className="text-[10px] bg-white text-blue-600 px-2 py-0.5 rounded border border-blue-200">
                      {hint}
                    </span>
                  ))}
                </div>
              </div>

              <div className="flex-1 p-4">
                <textarea
                  className="w-full h-full bg-transparent resize-none outline-none text-base leading-7 text-gray-800 placeholder-gray-300 font-sans"
                  placeholder="Please write your essay here..."
                  value={essayContent}
                  onChange={(e) => setEssayContent(e.target.value)}
                  spellCheck={false}
                />
              </div>

              <div className="bg-gray-50 border-t border-gray-200 p-3 pb-safe px-4 shrink-0">
                <div className="flex justify-between items-center mb-2">
                  <span className={`text-xs font-bold ${
                    wordCount < 80 ? 'text-gray-500' : wordCount > 100 ? 'text-red-500' : 'text-green-600'
                  }`}>
                    {wordCount} / 100 è¯
                  </span>
                  <span className="text-[10px] text-gray-400">ç›®æ ‡: 80-100</span>
                </div>
                <div className="h-1.5 w-full bg-gray-200 rounded-full overflow-hidden">
                  <div 
                    className={`h-full transition-all duration-300 ${wordCount > 100 ? 'bg-red-500' : wordCount >= 80 ? 'bg-green-500' : 'bg-blue-500'}`} 
                    style={{ width: `${Math.min((wordCount / 100) * 100, 100)}%` }}
                  ></div>
                </div>
              </div>
            </div>
          );
        };

        const ReviewView = ({ history, analysisResult, onHome }) => {
          if (!history.length || !analysisResult) return null;
          const currentEntry = history[0];
          
          return (
            <div className="pb-24 pt-6 px-4 bg-gray-50 min-h-screen animate-fade-in">
              <header className="mb-4 flex items-center gap-3">
                <div className="bg-green-500 text-white p-2 rounded-full shadow-lg shadow-green-200">
                  <Icons.Check />
                </div>
                <div>
                  <h1 className="text-xl font-bold text-gray-900">AI æ‰¹æ”¹å®Œæˆ</h1>
                  <p className="text-gray-500 text-xs">ä»¥ä¸‹æ˜¯æ‚¨çš„è¯Šæ–­æŠ¥å‘Š</p>
                </div>
              </header>

              <div className="bg-white rounded-2xl shadow-lg border border-gray-100 p-5 mb-6 text-center">
                <div className="text-sm text-gray-500 mb-1">AI é¢„ä¼°å¾—åˆ† (æ»¡åˆ†15)</div>
                <div className="text-4xl font-extrabold text-blue-600 mb-4">{analysisResult.score}</div>
                
                <div className="grid grid-cols-3 gap-2 text-xs border-t border-gray-100 pt-4">
                  <div>
                    <div className="text-gray-400">è¯æ±‡</div>
                    <div className="font-bold text-gray-800 mt-1">{analysisResult.dimensions?.vocabulary || "-"}</div>
                  </div>
                  <div className="border-l border-r border-gray-100">
                    <div className="text-gray-400">è¯­æ³•</div>
                    <div className="font-bold text-gray-800 mt-1">{analysisResult.dimensions?.grammar || "-"}</div>
                  </div>
                  <div>
                    <div className="text-gray-400">é€»è¾‘</div>
                    <div className="font-bold text-gray-800 mt-1">{analysisResult.dimensions?.logic || "-"}</div>
                  </div>
                </div>
              </div>

              <div className="mb-6">
                <h3 className="text-sm font-bold text-gray-700 mb-2">ğŸ’¡ æ”¹è¿›å»ºè®®</h3>
                <div className="space-y-2">
                  {analysisResult.comments.map((comment, idx) => (
                    <div key={idx} className="bg-orange-50 text-orange-800 text-xs px-3 py-2 rounded-lg border border-orange-100">
                      {comment}
                    </div>
                  ))}
                </div>
              </div>

              <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
                <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">æ‚¨çš„åŸæ–‡</h3>
                <p className="text-gray-800 leading-7 text-sm whitespace-pre-wrap font-serif">
                  {currentEntry.content || <span className="text-gray-300 italic">æ— å†…å®¹</span>}
                </p>
              </div>

              <div className="bg-gradient-to-b from-green-50 to-white border border-green-200 rounded-xl shadow-sm p-5 relative overflow-hidden">
                <div className="absolute top-0 right-0 p-2 opacity-10">
                  <Icons.Star />
                </div>
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-sm font-bold text-green-700 uppercase tracking-wider flex items-center gap-1">
                    <Icons.Sparkles /> AI ç”ŸæˆèŒƒæ–‡
                  </h3>
                  <span className="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded font-bold">Model Essay</span>
                </div>
                <p className="text-gray-800 leading-7 text-sm whitespace-pre-wrap font-serif">
                  {analysisResult.generatedModelEssay}
                </p>
                <div className="mt-4 pt-3 border-t border-green-100">
                    <p className="text-[10px] text-green-600 italic text-center">
                        *æ­¤èŒƒæ–‡ç”± AI æ ¹æ®é¢˜ç›®å³æ—¶ç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒã€‚
                    </p>
                </div>
              </div>

              <button 
                onClick={onHome}
                className="w-full mt-8 bg-gray-900 text-white py-4 rounded-xl font-bold shadow-xl active:scale-95 transition-transform"
              >
                è¿”å›é¦–é¡µ
              </button>
            </div>
          );
        };

        const VocabularyView = () => (
          <div className="pb-24 pt-6 px-4 animate-fade-in">
            <h1 className="text-2xl font-bold text-gray-900 mb-6">å¤‡è€ƒè¯æ±‡åº“</h1>
            {Object.entries(VOCAB_BANK).map(([category, words]) => (
              <div key={category} className="mb-6">
                <h2 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">{category}</h2>
                <div className="grid gap-2">
                  {words.map((word, idx) => (
                    <div key={idx} className="bg-white p-3.5 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                      <span className="font-bold text-blue-700 text-sm">{word.en}</span>
                      <span className="text-gray-600 text-sm bg-gray-50 px-2 py-0.5 rounded">{word.cn}</span>
                    </div>
                  ))}
                </div>
              </div>
            ))}
          </div>
        );

        const HistoryView = ({ history }) => (
          <div className="pb-24 pt-6 px-4 animate-fade-in">
            <h1 className="text-2xl font-bold text-gray-900 mb-6">ç»ƒä¹ è®°å½•</h1>
            {history.length === 0 ? (
              <div className="text-center py-20 text-gray-400">
                <p>æš‚æ— è®°å½•</p>
              </div>
            ) : (
              <div className="space-y-3">
                {history.map((entry, idx) => (
                  <div key={idx} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                    <div className="flex justify-between items-start">
                      <h3 className="font-bold text-gray-800 text-sm mb-1">{entry.topic?.title || "æœªçŸ¥é¢˜ç›®"}</h3>
                      <div className="text-blue-600 font-bold text-xs">
                        {entry.score}åˆ†
                      </div>
                    </div>
                    <p className="text-xs text-gray-500 mb-2">{entry.date}</p>
                    <div className="flex gap-2">
                      <span className="text-[10px] bg-gray-100 text-gray-600 px-2 py-1 rounded">
                        {entry.wordCount} words
                      </span>
                      {entry.topic?.difficulty === 'Custom' && (
                        <span className="text-[10px] bg-purple-100 text-purple-600 px-2 py-1 rounded">è‡ªå»º</span>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        );

        const BottomNav = ({ currentView, onChangeView }) => (
          <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-6 pb-6 pt-2 flex justify-between items-center z-40 shadow-lg">
            <button 
              onClick={() => onChangeView('home')} 
              className={`flex flex-col items-center space-y-1 w-16 ${currentView === 'home' || currentView === 'addTopic' ? 'text-blue-600' : 'text-gray-400'}`}
            >
              <Icons.Home />
              <span className="text-[10px] font-medium">é¦–é¡µ</span>
            </button>
            <button 
              onClick={() => onChangeView('vocabulary')} 
              className={`flex flex-col items-center space-y-1 w-16 ${currentView === 'vocabulary' ? 'text-blue-600' : 'text-gray-400'}`}
            >
              <Icons.Book />
              <span className="text-[10px] font-medium">è¯æ±‡</span>
            </button>
            <button 
              onClick={() => onChangeView('history')} 
              className={`flex flex-col items-center space-y-1 w-16 ${currentView === 'history' ? 'text-blue-600' : 'text-gray-400'}`}
            >
              <Icons.History />
              <span className="text-[10px] font-medium">è®°å½•</span>
            </button>
          </div>
        );

        // --- MAIN APP ---

        function App() {
          const [currentView, setCurrentView] = useState('home'); 
          const [apiKey, setApiKey] = useState(() => {
            try {
                return localStorage.getItem('gemini_api_key') || '';
            } catch {
                return '';
            }
          });
          const [topics, setTopics] = useState(INITIAL_TOPICS);
          const [selectedTopic, setSelectedTopic] = useState(null);
          const [essayContent, setEssayContent] = useState('');
          const [timeLeft, setTimeLeft] = useState(1200);
          const [isActive, setIsActive] = useState(false);
          const [history, setHistory] = useState([]);
          const [isAnalyzing, setIsAnalyzing] = useState(false);
          const [analysisResult, setAnalysisResult] = useState(null);

          // UI State
          const [toast, setToast] = useState({ show: false, message: '', type: 'success' });
          const [topicToDelete, setTopicToDelete] = useState(null); // ID of topic to delete

          // Form State
          const [topicForm, setTopicForm] = useState({ id: null, title: '', prompt: '', hints: '' });
          const [isEditing, setIsEditing] = useState(false);

          useEffect(() => {
            let interval = null;
            if (isActive && timeLeft > 0) {
              interval = setInterval(() => {
                setTimeLeft(t => t - 1);
              }, 1000);
            } else if (timeLeft === 0) {
              setIsActive(false);
            }
            return () => clearInterval(interval);
          }, [isActive, timeLeft]);

          // Auto-hide toast
          useEffect(() => {
            if (toast.show) {
                const timer = setTimeout(() => setToast(prev => ({...prev, show: false})), 3000);
                return () => clearTimeout(timer);
            }
          }, [toast.show]);

          const showToast = (message, type = 'success') => {
              setToast({ show: true, message, type });
          };

          const formatTime = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
          };

          const handleSaveSettings = (key) => {
              setApiKey(key);
              localStorage.setItem('gemini_api_key', key);
              showToast("API Key å·²ä¿å­˜", "success");
              setCurrentView('home');
          };

          const startPractice = (topic) => {
            setSelectedTopic(topic);
            setEssayContent('');
            setTimeLeft(1200); 
            setIsActive(true);
            setAnalysisResult(null);
            setCurrentView('practice');
          };

          // CRUD Handlers
          const handleOpenAdd = () => {
            setIsEditing(false);
            setTopicForm({ id: null, title: '', prompt: '', hints: '' });
            setCurrentView('addTopic');
          };

          const handleOpenEdit = (topic) => {
            setIsEditing(true);
            setTopicForm({
              id: topic.id,
              title: topic.title,
              prompt: topic.prompt,
              hints: topic.hints ? topic.hints.join(', ') : ''
            });
            setCurrentView('addTopic');
          };

          const handleDeleteClick = (id) => {
              setTopicToDelete(id);
          };

          const confirmDelete = () => {
              if (topicToDelete) {
                  setTopics(topics.filter(t => t.id !== topicToDelete));
                  setTopicToDelete(null);
                  showToast("é¢˜ç›®å·²åˆ é™¤", "success");
              }
          };

          const handleTopicSubmit = () => {
            if (!topicForm.title || !topicForm.prompt) {
              showToast("è¯·å¡«å†™é¢˜ç›®åç§°å’Œè¦æ±‚", "error");
              return;
            }

            const hintsArray = topicForm.hints ? topicForm.hints.split(/[,ï¼Œ]/).map(s => s.trim()).filter(s => s) : [];

            if (isEditing) {
              setTopics(topics.map(t => t.id === topicForm.id ? {
                ...t,
                title: topicForm.title,
                prompt: topicForm.prompt,
                hints: hintsArray
              } : t));
              showToast("é¢˜ç›®å·²æ›´æ–°", "success");
            } else {
              const newTopic = {
                id: Date.now(),
                year: "è‡ªå»ºé¢˜ç›®",
                type: "è‡ªå®šä¹‰",
                difficulty: "Custom",
                title: topicForm.title,
                prompt: topicForm.prompt,
                hints: hintsArray,
                modelEssay: "" 
              };
              setTopics([newTopic, ...topics]);
              showToast("æ–°é¢˜ç›®å·²æ·»åŠ ", "success");
            }
            setCurrentView('home');
          };

          const submitEssay = async () => {
            if (!apiKey) {
                showToast("âš ï¸ è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API Key", "error");
                // Optional: Auto open settings after delay? No, keeps UI simple.
                return;
            }

            setIsActive(false);
            setIsAnalyzing(true);

            const aiPrompt = `
              Act as a strict but encouraging English teacher for Chinese middle school students.
              
              Topic Title: "${selectedTopic.title}"
              Topic Requirement: "${selectedTopic.prompt}"
              
              Student Essay: "${essayContent}"
              
              Please perform two tasks:
              1. Grade the essay (0-15 scale) and provide short comments in Simplified Chinese.
              2. WRITE A PERFECT MODEL ESSAY (approx 80-100 words) based on the topic title and requirement.
              
              Return a JSON object with this structure:
              {
                "score": number,
                "dimensions": {
                   "vocabulary": "Excellent/Good/Average/Poor",
                   "grammar": "Excellent/Good/Average/Poor",
                   "logic": "Excellent/Good/Average/Poor"
                },
                "comments": ["comment 1", "comment 2", "comment 3"],
                "generatedModelEssay": "The full text of the perfect model essay here..."
              }
            `;

            try {
              const resultJsonString = await callGemini(aiPrompt, apiKey, "application/json");
              let result = null;
              
              if (resultJsonString) {
                result = JSON.parse(resultJsonString);
              } else {
                result = {
                    score: 0,
                    dimensions: { vocabulary: "-", grammar: "-", logic: "-" },
                    comments: ["AI æœåŠ¡å“åº”ä¸ºç©ºï¼Œè¯·é‡è¯•ã€‚"],
                    generatedModelEssay: "AI ç”ŸæˆèŒƒæ–‡å¤±è´¥ã€‚"
                };
              }
              
              setAnalysisResult(result);
              
              const newEntry = {
                topic: selectedTopic || {},
                content: essayContent,
                date: new Date().toLocaleDateString(),
                wordCount: essayContent.trim() === '' ? 0 : essayContent.trim().split(/\s+/).length,
                score: result.score
              };
              
              setHistory(prev => [newEntry, ...prev]);
              setIsAnalyzing(false);
              setCurrentView('review');
              
            } catch (e) {
              console.error("Error parsing AI result", e);
              setIsAnalyzing(false);
              showToast("AI åˆ†æå‡ºé”™ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– API Key", "error");
            }
          };

          return (
            <div className="bg-gray-50 min-h-screen font-sans text-gray-900 max-w-md mx-auto relative overflow-hidden shadow-2xl">
              {/* Global Toast */}
              <Toast message={toast.message} type={toast.type} show={toast.show} />

              {/* Delete Confirmation Modal */}
              <ConfirmModal 
                isOpen={!!topicToDelete} 
                title="ç¡®è®¤åˆ é™¤"
                message="æ‚¨ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¢˜ç›®å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚"
                onConfirm={confirmDelete}
                onCancel={() => setTopicToDelete(null)}
              />

              {currentView === 'settings' && (
                  <SettingsView 
                    apiKey={apiKey}
                    setApiKey={setApiKey}
                    onSave={handleSaveSettings}
                    onCancel={() => setCurrentView('home')}
                  />
              )}

              {currentView === 'addTopic' && (
                <AddTopicView 
                  form={topicForm} 
                  setForm={setTopicForm} 
                  onSubmit={handleTopicSubmit} 
                  onCancel={() => setCurrentView('home')}
                  isEditing={isEditing}
                  apiKey={apiKey}
                  onShowToast={showToast}
                />
              )}
              
              {currentView === 'home' && (
                <HomeView 
                  topics={topics} 
                  onStartPractice={startPractice} 
                  onAddTopic={handleOpenAdd}
                  onEditTopic={handleOpenEdit}
                  onDeleteTopic={handleDeleteClick}
                  onOpenSettings={() => setCurrentView('settings')}
                />
              )}

              {currentView === 'practice' && (
                <PracticeView 
                  selectedTopic={selectedTopic}
                  essayContent={essayContent}
                  setEssayContent={setEssayContent}
                  timeLeft={timeLeft}
                  submitEssay={submitEssay}
                  isAnalyzing={isAnalyzing}
                  onCancel={() => {setIsActive(false); setCurrentView('home');}}
                  formatTime={formatTime}
                />
              )}

              {currentView === 'review' && (
                <ReviewView 
                  history={history} 
                  analysisResult={analysisResult} 
                  onHome={() => setCurrentView('home')} 
                />
              )}

              {currentView === 'vocabulary' && <VocabularyView />}
              {currentView === 'history' && <HistoryView history={history} />}
              
              {currentView !== 'practice' && currentView !== 'addTopic' && currentView !== 'settings' && (
                <BottomNav currentView={currentView} onChangeView={setCurrentView} />
              )}
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>